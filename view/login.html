<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel — Iniciar sesión</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../asset/img/web.png" />
  <link rel="stylesheet" href="../style.css" />
  <style>
    /* Sólo para el mensaje de error/aviso, no modifica tu fondo ni card */
    .admin-note{ color:#b7ffc0; font-size:.92rem; }
    .err{
      margin-top:10px;padding:8px 12px;border-radius:8px;
      background:#240d10;border:1px solid #5c1d25;color:#ffb9c1;
      text-align:center; box-shadow:0 10px 25px rgba(0,0,0,.35); display:none;
    }
  </style>
</head>
<body>

  <!-- === TU ESTRUCTURA: SECTION + SPANS (NO SE QUITAN) === -->
  <section>
    <!-- 🔹 Spans del fondo (160 unidades). Ajusta cantidad si tu CSS lo requiere. -->
    <!-- 1-40 -->
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <!-- 41-80 -->
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <!-- 81-120 -->
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <!-- 121-160 -->
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>

    <!-- === TU CARD DE LOGIN === -->
     <div class="signin">
      <div class="content">
        <div style="display:flex;align-items:center;gap:.5rem;justify-content:center;opacity:.9">
          <img src="../asset/img/web.png" alt="logo" style="height:26px" />
          <small style="color:#b9ffbf">Panel</small>
        </div>

        <h2>INICIAR SESIÓN</h2>

        <form id="loginForm" class="form" autocomplete="on">
          <div class="inputBox">
            <input id="email" type="email" required autocomplete="username" />
            <i>Email</i>
          </div>

          <div class="inputBox">
            <input id="pass" type="password" required autocomplete="current-password" />
            <i>Contraseña</i>
          </div>

          <div class="inputBox">
            <input type="submit" value="Iniciar sesión" />
          </div>

          <!-- dentro del form… debajo del botón “Iniciar sesión” -->
        <!-- Separador -->
        <div class="divider"><span>o</span></div>

        <!-- Botón Google solo con icono -->
        <div class="social-login">
          <button type="button" id="btnGoogle" class="btn-google-circle" aria-label="Acceder con Google">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="#EA4335" d="M12 10.2v3.9h5.5c-.2 1.3-1.7 3.8-5.5 3.8-3.3 0-6-2.7-6-6s2.7-6 6-6c1.9 0 3.2.8 4 1.5l2.7-2.6C15.8 3 14 2.2 12 2.2 6.9 2.2 2.8 6.3 2.8 11.4S6.9 20.6 12 20.6c6.9 0 9.2-4.8 9.2-7.2 0-.5-.1-1-.2-1.4H12z"/>
              <path fill="#FBBC05" d="M12 22c-4.6 0-8.5-3.2-9.6-7.5l3.2-2.5c.6 2.8 3.1 4.9 6.4 4.9 2.3 0 4.3-1.1 5.4-2.8l3.1 2.4C18.9 19.8 15.8 22 12 22z"/>
              <path fill="#4285F4" d="M21.2 13.4c0-.5-.1-1-.2-1.4H12v3.9h5.5c-.3 1.3-1.7 3.8-5.5 3.8v3c6.9 0 9.2-4.8 9.2-7.3z"/>
              <path fill="#34A853" d="M6.8 13.9l-3.2 2.5C4.7 20.7 8.1 23 12 23v-3c-3.4 0-5.9-2.1-6.4-5.1z"/>
            </svg>
          </button>
        </div>







          <p id="msg" class="err" aria-live="polite"></p>
        </form>
      </div>
    </div>
  </section>

 <script type="module">
  import {
    requireAnon, loginWithEmail, loginWithGooglePopup,
    auth, ALLOW, upsertUserProfile, rememberEmail, getSavedEmail
  } from "../js/auth.js";
  import { sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  // Si ya está logueado y permitido → admin
  await requireAnon("/view/admin.html");

  const $ = (id) => document.getElementById(id);
  const show = (t, ok=false) => {
    const el = $("msg");
    if (!t){ el.style.display="none"; el.textContent=""; return; }
    el.textContent = t; el.style.display = "block";
    el.style.background = ok ? "#0f2416" : "#240d10";
    el.style.borderColor = ok ? "#1f3b24" : "#5c1d25";
    el.style.color = ok ? "#bfffd2" : "#ffb9c1";
  };

  // Autocompletar email guardado
  const saved = getSavedEmail();
  if (saved) $("email").value = saved;

  // Email/Password
  $("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault(); show("");
    const email = $("email").value.trim();
    const pass  = $("pass").value;
    if (!email || !pass){ show("Completa email y contraseña."); return; }
    try {
      const cred = await loginWithEmail(email, pass);
      if (!ALLOW.includes(cred.user.email || "")) {
        show("Usuario no autorizado."); return;
      }
      rememberEmail(email);
      await upsertUserProfile(cred.user);
      location.replace("/view/admin.html");
    } catch (err) {
      const map = {
        "auth/invalid-credential":"Email o contraseña incorrectos.",
        "auth/wrong-password":"Contraseña incorrecta.",
        "auth/user-not-found":"Usuario no encontrado.",
        "auth/too-many-requests":"Demasiados intentos. Intenta más tarde.",
        "auth/operation-not-allowed":"Habilita Email/Password en Authentication → Método de acceso."
      };
      // Sugerir Google si el mail ya existe con Google
      if (err.code === "auth/user-not-found" || err.code === "auth/wrong-password") {
        show((map[err.code] || "Error") + " — Si tu correo está con Google, usa “Acceder con Google”.");
      } else {
        show(map[err.code] || (err.message || "No se pudo iniciar sesión."));
      }
    }
  });

  // Google
  $("btnGoogle").addEventListener("click", async () => {
    show("");
    try {
      const cred = await loginWithGooglePopup();
      if (!ALLOW.includes(cred.user.email || "")) {
        show("Usuario no autorizado."); return;
      }
      rememberEmail(cred.user.email || "");
      await upsertUserProfile(cred.user);
      location.replace("/view/admin.html");
    } catch (err) {
      const map = {
        "auth/popup-closed-by-user":"Ventana cerrada.",
        "auth/cancelled-popup-request":"Se canceló la ventana.",
        "auth/operation-not-allowed":"Habilita Google en Authentication → Método de acceso."
      };
      show(map[err.code] || (err.message || "No se pudo iniciar con Google."));
    }
  });

  
</script>

</body>
</html>